#!/usr/bin/env bash

set -euo pipefail

readonly ref=$1
if [[ "$ref" == -* ]]; then
  echo "error: invalid ref starts with dash: $ref" >&2
  exit 1
fi

branch=$(git show --no-patch --no-show-signature --format=%f "$ref")
if [[ -z "$branch" ]]; then
  echo "error: no branch found for ref: $ref" >&2
  exit 1
fi

raw_branch=$(git show --no-patch --no-show-signature --format=%s "$ref")
if [[ -z "$raw_branch" ]]; then
  echo "error: no branch found for ref: $ref" >&2
  exit 1
fi

# add check if a branch exists with exactly the commit name (case-sensitive), then return its name
if git for-each-ref --format='%(refname:short)' refs/heads | grep -Fx -- "$raw_branch" >/dev/null; then
  echo "$raw_branch"
  exit 0
fi

branch_name="${GIT_PILE_PREFIX:-}$(echo "$branch" | tr '[:upper:]' '[:lower:]' | sed -e 's/^\.*//' -e 's/\.lock$/-lock/')"
echo "$branch_name"
